---
name: Build Release Version

on:
  # Create release if tag is pushed to main.
  # Needs: secrets.PLATOMO_BUILDER_ACCESS
  push:
    tags:
      - "v*.*.*.*"

permissions: read-all

jobs:
  test:
    if: endsWith(github.event.base_ref, 'main')
    uses: './.github/workflows/test.yml'
  create-release:
    needs:
      - test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Update Version
        uses: platomo/update-version-py-action@main
        with:
          version: ${{ github.ref_name }}
          file-path: OTVision
      - name: Create Release
        uses: platomo/build-release-asset-action@main
        with:
          platomo-token: ${{ secrets.PLATOMO_BUILDER_ACCESS }}
          package-version: ${{ github.ref_name }}
          save-artifacts: true
      - name: Publish Release
        uses: platomo/publish-release-action@main
        with:
          package-version: ${{ github.ref_name }}
          delete-existing: false
          pre-release: false
          py-version: "3.11"
          draft-release: false
